services:
  # Playwright MCP server - persistent HTTP service for browser automation
  playwright-mcp:
    image: mcr.microsoft.com/playwright:v1.49.1-noble
    container_name: playwright-mcp
    restart: unless-stopped
    # Required for Chromium in containers
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    ipc: host
    volumes:
      # Share workspace for screenshots/downloads
      - ./workspace:/workspace
    command: >-
      npx -y @playwright/mcp@latest
      --browser chromium
      --headless
      --no-sandbox
      --port 3000
      --host 0.0.0.0
      --allowed-hosts '*'
      --timeout-action 30000
      --timeout-navigation 60000
      --output-dir /workspace
      --viewport-size 1280x720
    healthcheck:
      # Server returns HTTP 400 on / which is expected - just verify it's listening
      # Using --fail-with-body to get exit 0 on any response (including 4xx)
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/ | grep -qE '^[0-9]+$'"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  whatsapp-claude-agent:
    build:
      context: .
      target: development
    image: whatsapp-claude-agent:latest
    container_name: whatsapp-claude-agent
    restart: unless-stopped
    stdin_open: true
    tty: true
    depends_on:
      playwright-mcp:
        condition: service_healthy
    # Required for Chromium/Playwright in containers (for local fallback)
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    # Prevents shared memory issues with Chromium (avoids crashes/hangs)
    ipc: host
    env_file:
      - .env
    environment:
      # Required: Your Anthropic API key
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Pass config as env vars for proper shell expansion
      - WHATSAPP_WHITELIST=${WHATSAPP_WHITELIST:-+1234567890}
      - AGENT_NAME=${AGENT_NAME:-Claude}
      - DEVICE_NAME=${DEVICE_NAME:-WhatsApp-Claude-Agent}
      # Playwright MCP server URL (sidecar service)
      - PLAYWRIGHT_MCP_URL=http://playwright-mcp:3000
    volumes:
      # Persist WhatsApp session (QR auth)
      - whatsapp-session:/app/.whatsapp-session
      # Persist agent config
      - ./config:/app/config
      # Workspace for Claude to access files
      - ./workspace:/workspace
      # Persist Playwright browsers (auto-copies from image on first run)
      # To update browsers after rebuild: docker volume rm whatsapp-claude-agent_agent-cache
      - agent-cache:/home/agent/.cache
      # Claude Code config is baked into the image with:
      # - MCP servers: ~/.claude.json (Playwright pre-configured)
      # - Permissions: ~/.claude/settings.json (mcp__* auto-approved)
      # Uncomment below to persist/override Claude settings:
      # - claude-config:/home/agent/.claude
      # Optional: Mount source for development
      # - .:/app
    # Use shell form for proper environment variable expansion
    command: >-
      --whitelist "$WHATSAPP_WHITELIST"
      --directory /workspace
      --session /app/.whatsapp-session
      --agent-name "$AGENT_NAME"
      --device-name "$DEVICE_NAME"
      --mode bypassPermissions
  #    --reset-session

  # Production variant (uncomment to use)
  # whatsapp-claude-agent-prod:
  #   build:
  #     context: .
  #     target: production
  #   container_name: whatsapp-claude-agent-prod
  #   restart: unless-stopped
  #   stdin_open: true
  #   tty: true
  #   # Required for Chromium sandbox in Playwright
  #   cap_add:
  #     - SYS_ADMIN
  #   security_opt:
  #     - seccomp:unconfined
  #   env_file:
  #     - .env
  #   environment:
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
  #     - WHATSAPP_WHITELIST=${WHATSAPP_WHITELIST:-+1234567890}
  #     - AGENT_NAME=${AGENT_NAME:-Claude}
  #     - DEVICE_NAME=${DEVICE_NAME:-WhatsApp-Claude-Agent}
  #   volumes:
  #     - whatsapp-session-prod:/app/.whatsapp-session
  #     - ./config:/app/config
  #     - ./workspace:/workspace
  #     - agent-cache-prod:/home/agent/.cache
  #   command: >-
  #     --whitelist "$WHATSAPP_WHITELIST"
  #     --directory /workspace
  #     --session /app/.whatsapp-session
  #     --agent-name "$AGENT_NAME"
  #     --device-name "$DEVICE_NAME"
  #     --mode bypassPermissions

volumes:
  whatsapp-session:
  agent-cache:
  # Uncomment if you want to persist Claude Code settings after container recreation
  # claude-config:
